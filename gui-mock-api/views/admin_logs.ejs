<%
  const escapeHtml = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const keyQuery = query.key ? `?key=${encodeURIComponent(query.key)}` : '';
  const formatBodyPreview = (raw) => {
    if (!raw) return '<span class="muted">—</span>';
    try {
      const parsed = JSON.parse(raw);
      const stringified = JSON.stringify(parsed);
      const truncated = stringified.length > 120
        ? `${stringified.slice(0, 117)}...`
        : stringified;
      return `<code>${escapeHtml(truncated)}</code>`;
    } catch (err) {
      const trimmed = raw.length > 120 ? `${raw.slice(0, 117)}...` : raw;
      return `<code>${escapeHtml(trimmed)}</code>`;
    }
  };

  const rows = (logs || []).map((log) => {
    const statusCode = Number(log.status);
    let statusClass = 'status-badge status-badge--muted';
    if (statusCode >= 200 && statusCode < 300) {
      statusClass = 'status-badge status-badge--success';
    } else if (statusCode >= 500) {
      statusClass = 'status-badge status-badge--error';
    } else if (statusCode >= 400) {
      statusClass = 'status-badge status-badge--warn';
    }

    return `
      <tr>
        <td>
          <div style="display:flex; flex-direction:column; gap:0.25rem;">
            <strong>${escapeHtml(log.created_at)}</strong>
            <span class="muted" style="font-size:0.85rem;">${escapeHtml(log.response_ms)} ms</span>
          </div>
        </td>
        <td><span class="${statusClass}">${escapeHtml(log.status)}</span></td>
        <td><code>${escapeHtml(log.method)}</code></td>
        <td><code>${escapeHtml(log.path)}</code></td>
        <td>${formatBodyPreview(log.body)}</td>
        <td>
          <div class="table-actions">
            <a class="secondary" href="/admin/logs/${encodeURIComponent(log.id)}${keyQuery}">View</a>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  const body = `
    <section class="page-hero page-hero--compact">
      <div class="page-hero__content">
        <h2>Recent logs</h2>
        <p>Inspect the last requests served by <code>${escapeHtml(e.method)} ${escapeHtml(e.path)}</code>.</p>
      </div>
      <div class="page-hero__actions">
        <a class="secondary" href="/admin/${encodeURIComponent(e.id)}${keyQuery}">Back to endpoint</a>
      </div>
    </section>
    <section class="surface-card">
      <div class="table-card">
        <table>
          <thead>
            <tr><th>When</th><th>Status</th><th>Method</th><th>Path</th><th>Request body</th><th>Actions</th></tr>
          </thead>
          <tbody>
            ${rows || `<tr><td class="empty-state" colspan="6">No logs captured yet.</td></tr>`}
          </tbody>
        </table>
      </div>
    </section>
  `;
%>
<%- include('layout', { title: `Logs · ${e.method} ${e.path}`, body }) %>
