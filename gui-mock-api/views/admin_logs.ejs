<%
  const escapeHtml = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const keyQuery = query.key ? `?key=${encodeURIComponent(query.key)}` : '';
  const formatBodyPreview = (raw) => {
    if (!raw) return '<span class="muted">—</span>';
    try {
      const parsed = JSON.parse(raw);
      const stringified = JSON.stringify(parsed);
      const truncated = stringified.length > 120
        ? `${stringified.slice(0, 117)}...`
        : stringified;
      return `<code>${escapeHtml(truncated)}</code>`;
    } catch (err) {
      const trimmed = raw.length > 120 ? `${raw.slice(0, 117)}...` : raw;
      return `<code>${escapeHtml(trimmed)}</code>`;
    }
  };

  const rows = (logs || []).map((log) => `
    <tr>
      <td>${escapeHtml(log.created_at)}</td>
      <td>${escapeHtml(log.status)}</td>
      <td>${escapeHtml(log.response_ms)}</td>
      <td>${escapeHtml(log.method)}</td>
      <td><code>${escapeHtml(log.path)}</code></td>
      <td>${formatBodyPreview(log.body)}</td>
      <td class="right"><a class="secondary" href="/admin/logs/${encodeURIComponent(log.id)}${keyQuery}">View</a></td>
    </tr>
  `).join('');

  const body = `
    <section>
      <header class="flex" style="justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div>
          <h2 style="margin-bottom: 0.25rem;">Logs for <code>${escapeHtml(e.method)} ${escapeHtml(e.path)}</code></h2>
          <p class="muted" style="margin: 0;">Inspect the most recent requests handled by this endpoint.</p>
        </div>
        <a class="secondary" href="/admin/${encodeURIComponent(e.id)}${keyQuery}">Back to endpoint</a>
      </header>
      <table>
        <thead>
          <tr><th>When</th><th>Status</th><th>ms</th><th>Method</th><th>Path</th><th>Request body</th><th></th></tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="7" class="muted">No logs captured yet.</td></tr>`}
        </tbody>
      </table>
    </section>
  `;
%>
<%- include('layout', { title: `Logs · ${e.method} ${e.path}`, body }) %>
