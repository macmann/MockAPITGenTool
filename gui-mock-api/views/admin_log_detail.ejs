<%
  const escapeHtml = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const pretty = (raw, fallback = '{}') => {
    try {
      const parsed = JSON.parse(raw || fallback);
      return escapeHtml(JSON.stringify(parsed, null, 2));
    } catch (err) {
      return escapeHtml(String(raw ?? ''));
    }
  };

  const keyQuery = query.key ? `?key=${encodeURIComponent(query.key)}` : '';

  const statusCode = Number(log.status);
  let statusBadge = 'status-badge status-badge--muted';
  if (statusCode >= 200 && statusCode < 300) {
    statusBadge = 'status-badge status-badge--success';
  } else if (statusCode >= 500) {
    statusBadge = 'status-badge status-badge--error';
  } else if (statusCode >= 400) {
    statusBadge = 'status-badge status-badge--warn';
  }

  const body = `
    <section class="page-hero page-hero--compact">
      <div class="page-hero__content">
        <h2>Log ${escapeHtml(log.id)}</h2>
        <p>Captured ${escapeHtml(log.created_at)} Â· ${escapeHtml(log.response_ms)} ms</p>
      </div>
      <div class="page-hero__actions">
        <a class="secondary" href="/admin/${encodeURIComponent(log.endpoint_id || '')}/logs${keyQuery}">Back to logs</a>
      </div>
    </section>
    <section class="surface-card surface-card--stacked">
      <header class="section-heading">
        <div>
          <h3>Request details</h3>
          <p class="muted" style="margin: 0;">${escapeHtml(log.method)} request to <code>${escapeHtml(log.path)}</code></p>
        </div>
        <span class="${statusBadge}">Status ${escapeHtml(log.status)}</span>
      </header>
      <div class="stack stack--lg">
        <div class="stack">
          <h4 style="margin: 0;">Request line</h4>
          <pre><code>${escapeHtml(`${log.method} ${log.path}`)}</code></pre>
        </div>
        <div class="stack">
          <h4 style="margin: 0;">Path parameters</h4>
          <pre><code>${pretty(log.matched_params)}</code></pre>
        </div>
        <div class="stack">
          <h4 style="margin: 0;">Query</h4>
          <pre><code>${pretty(log.query)}</code></pre>
        </div>
        <div class="stack">
          <h4 style="margin: 0;">Headers</h4>
          <pre><code>${pretty(log.headers)}</code></pre>
        </div>
        <div class="stack">
          <h4 style="margin: 0;">Body</h4>
          <pre><code>${pretty(log.body, 'null')}</code></pre>
        </div>
      </div>
    </section>
  `;
%>
<%- include('layout', { title: `Log ${log.id}`, body }) %>
