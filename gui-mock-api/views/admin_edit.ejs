<%
  const escapeHtml = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const currentEndpoint = route || endpoint || {};
  const keyQuery = query.key ? `?key=${encodeURIComponent(query.key)}` : '';
  const formAction = `/admin/save${keyQuery}`;
  const deleteAction = currentEndpoint.id ? `/admin/${encodeURIComponent(currentEndpoint.id)}/delete${keyQuery}` : '';
  const varsLink = currentEndpoint.id ? `/admin/${encodeURIComponent(currentEndpoint.id)}/vars${keyQuery}` : '';
  const logsLink = currentEndpoint.id ? `/admin/${encodeURIComponent(currentEndpoint.id)}/logs${keyQuery}` : '';

  const methodChoices = [
    { value: 'GET', label: 'GET â€” Retrieve data' },
    { value: 'POST', label: 'POST â€” Create something' },
    { value: 'PUT', label: 'PUT â€” Replace existing data' },
    { value: 'PATCH', label: 'PATCH â€” Update part of the data' },
    { value: 'DELETE', label: 'DELETE â€” Remove data' },
    { value: 'OPTIONS', label: 'OPTIONS â€” Return supported methods' },
    { value: 'HEAD', label: 'HEAD â€” Retrieve headers only' }
  ];
  const currentMethod = String(currentEndpoint.method || 'GET').toUpperCase();
  let methodOptions = methodChoices
    .map(({ value, label }) => `<option value="${value}" ${value === currentMethod ? 'selected' : ''}>${label}</option>`)
    .join('');
  if (!methodChoices.some(choice => choice.value === currentMethod)) {
    methodOptions += `<option value="${escapeHtml(currentMethod)}" selected>Current (${escapeHtml(currentMethod)})</option>`;
  }

  const statusChoices = [
    { value: '200', label: '200 â€“ OK (success)' },
    { value: '201', label: '201 â€“ Created' },
    { value: '202', label: '202 â€“ Accepted' },
    { value: '204', label: '204 â€“ No content' },
    { value: '400', label: '400 â€“ Bad request' },
    { value: '401', label: '401 â€“ Unauthorized' },
    { value: '403', label: '403 â€“ Forbidden' },
    { value: '404', label: '404 â€“ Not found' },
    { value: '409', label: '409 â€“ Conflict' },
    { value: '422', label: '422 â€“ Validation error' },
    { value: '500', label: '500 â€“ Server error' }
  ];
  const currentStatus = String(currentEndpoint.response_status ?? 200);
  const hasPresetStatus = statusChoices.some(choice => choice.value === currentStatus);
  const statusOptions = `${statusChoices
    .map(({ value, label }) => `<option value="${value}" ${value === currentStatus ? 'selected' : ''}>${label}</option>`)
    .join('')}<option value="custom" ${hasPresetStatus ? '' : 'selected'}>Custom statusâ€¦</option>`;
  const customStatusValue = hasPresetStatus ? '' : escapeHtml(currentStatus);

  const responseTemplateOptions = [
    { value: '', label: 'Choose a quick response (optional)' },
    { value: 'success', label: 'âœ… 200 Â· Success message' },
    { value: 'created', label: 'âœ… 201 Â· Created confirmation' },
    { value: 'empty', label: 'â„¹ï¸ 204 Â· Empty response' },
    { value: 'not_found', label: 'ðŸš« 404 Â· Not found message' },
    { value: 'conflict', label: 'âš ï¸ 409 Â· Conflict explanation' },
    { value: 'error', label: 'âŒ 500 Â· Something went wrong' }
  ];
  const responseTemplateSelectOptions = responseTemplateOptions
    .map(({ value, label }, idx) => `<option value="${value}" ${idx === 0 ? 'selected' : ''}>${label}</option>`)
    .join('');

  const body = `
    <section class="page-hero">
      <div class="page-hero__content">
        <h2>${escapeHtml(title || 'Endpoint')}</h2>
        <p>Follow the guided steps to describe your endpointâ€”no code snippets required.</p>
      </div>
      <div class="page-hero__actions">
        <a class="secondary" href="/admin${keyQuery}">Back to routes</a>
        ${currentEndpoint.id ? `<a class="secondary" href="${varsLink}">Vars</a>` : ''}
        ${currentEndpoint.id ? `<a class="secondary" href="${logsLink}">Logs</a>` : ''}
      </div>
    </section>
    <section class="surface-card surface-card--stacked">
      <form method="post" action="${formAction}" class="form-stack">
        <input type="hidden" name="id" value="${escapeHtml(currentEndpoint.id || '')}" />

        <fieldset>
          <legend>Step 1 Â· Give it a friendly name</legend>
          <p class="muted">Add notes that make sense to your team. These are for you and do not affect the API.</p>
          <div class="form-grid form-grid--two">
            <label class="stack">
              <span>Name</span>
              <input name="name" placeholder="Catalog lookup" value="${escapeHtml(currentEndpoint.name || '')}" />
            </label>
            <label class="stack">
              <span>Description</span>
              <input name="description" placeholder="Optional notes" value="${escapeHtml(currentEndpoint.description || '')}" />
            </label>
          </div>
          <label class="checkbox">
            <input type="checkbox" name="enabled" value="true" ${currentEndpoint.enabled !== false ? 'checked' : ''} />
            <span>Make this endpoint live right away</span>
          </label>
        </fieldset>

        <fieldset>
          <legend>Step 2 Â· Choose how clients will call it</legend>
          <p class="muted">Select the HTTP method and URL path the mock API should listen to.</p>
          <div class="form-grid form-grid--three">
            <label class="stack">
              <span>Method</span>
              <select name="method" required>
                ${methodOptions}
              </select>
            </label>
            <label class="stack">
              <span>Path</span>
              <input name="path" required value="${escapeHtml(currentEndpoint.path || '/')}" placeholder="/catalog/items" />
              <small class="muted">Paths should start with a forward slash.</small>
            </label>
            <label class="stack">
              <span>Delay (ms)</span>
              <input type="number" min="0" name="response_delay_ms" value="${escapeHtml(currentEndpoint.response_delay_ms ?? 0)}" />
              <small class="muted">Optional wait time before the response is sent.</small>
            </label>
          </div>
        </fieldset>

        <fieldset>
          <legend>Step 3 Â· Decide on the response</legend>
          <p class="muted">Pick a quick template or describe the message you want clients to see.</p>
          <div class="form-grid form-grid--two" style="align-items: end;">
            <label class="stack">
              <span>Quick start templates</span>
              <select data-response-template>
                ${responseTemplateSelectOptions}
              </select>
              <small class="muted">Weâ€™ll fill in the response for you. Existing text stays unless you confirm a change.</small>
            </label>
            <label class="stack">
              <span>Status code</span>
              <input type="hidden" data-status-value name="response_status" value="${escapeHtml(currentStatus)}" />
              <select data-status-select>
                ${statusOptions}
              </select>
            </label>
          </div>
          <div data-status-custom style="${hasPresetStatus ? 'display: none;' : ''}">
            <label class="stack">
              <span>Custom status code</span>
              <input type="number" min="100" max="599" value="${customStatusValue}" data-status-custom-input />
              <small class="muted">Use this if you need a status outside the common list.</small>
            </label>
          </div>
          <label class="stack">
            <span>Response body</span>
            <textarea name="response_body" rows="8" placeholder='Tell the client what happened' data-response-body>${escapeHtml(currentEndpoint.response_body || '')}</textarea>
            <small class="muted">Write the message youâ€™d like the API to return. Templates can populate this automatically.</small>
          </label>
          <div class="form-grid form-grid--two">
            <label class="checkbox">
              <input type="checkbox" name="response_is_json" value="true" ${currentEndpoint.response_is_json ? 'checked' : ''} data-response-json />
              <span>Format response as JSON<br><small class="muted">Weâ€™ll validate the JSON for you before saving.</small></span>
            </label>
            <label class="checkbox">
              <input type="checkbox" name="template_enabled" value="true" ${currentEndpoint.template_enabled ? 'checked' : ''} data-template-toggle />
              <span>Use Handlebars placeholders<br><small class="muted" data-template-hint>Great when you want to insert dynamic values from Vars. Weâ€™ll automatically enable this when we detect <code>{{...}}</code> placeholders in your response.</small></span>
            </label>
          </div>
        </fieldset>

        <details>
          <summary>Advanced settings (optional)</summary>
          <div class="form-grid form-grid--two" style="margin-top: 1rem;">
            <label class="stack">
              <span>Require specific headers</span>
              <textarea data-json-field name="match_headers" rows="3" placeholder='{"x-api-version":"1"}'>${escapeHtml(currentEndpoint.match_headers || '{}')}</textarea>
              <small class="muted">Only match requests that include these header names and values.</small>
            </label>
            <label class="stack">
              <span>Extra response headers</span>
              <textarea data-json-field data-response-headers name="response_headers" rows="3" placeholder='{"Content-Type":"application/json"}'>${escapeHtml(currentEndpoint.response_headers || '{}')}</textarea>
              <small class="muted">Weâ€™ll add <code>Content-Type</code> automatically when JSON is selected.</small>
            </label>
          </div>
        </details>

        <button type="submit" class="button primary" style="justify-self: flex-start;">Save endpoint</button>
      </form>
    </section>
    ${currentEndpoint.id ? `
      <section class="surface-card">
        <header class="section-heading">
          <div>
            <h3>Danger zone</h3>
            <p class="muted" style="margin: 0;">Remove this endpoint and all of its stored logs.</p>
          </div>
        </header>
        <form method="post" action="${deleteAction}" onsubmit="return confirm('Delete this endpoint?');" class="action-buttons">
          <button class="button contrast" type="submit">Delete endpoint</button>
        </form>
      </section>
    ` : ''}
  `;
%>
<%- include('layout', { title: title || 'Endpoint', body }) %>
