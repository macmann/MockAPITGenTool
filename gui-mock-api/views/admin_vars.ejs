<%
  const escapeHtml = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const keyQuery = query.key ? `?key=${encodeURIComponent(query.key)}` : '';
  const responseBody = String(e.response_body || '');
  const placeholderRegex = /{{\s*vars\.([a-zA-Z0-9_\.\-]+)\s*}}/g;
  const responseVars = [];
  let match;
  while ((match = placeholderRegex.exec(responseBody)) !== null) {
    const name = match[1];
    if (name && !responseVars.includes(name)) {
      responseVars.push(name);
    }
  }

  const varsByKey = Object.fromEntries((vars || []).map((row) => [row.k, row]));

  const varsRows = (vars || []).map((row) => `
    <tr>
      <td><code>${escapeHtml(row.k)}</code></td>
      <td>${escapeHtml(row.v)}</td>
      <td class="right">
        <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/delete${keyQuery}" onsubmit="return confirm('Delete variable?');" style="display:inline-flex; gap: 0.5rem; align-items: center;">
          <input type="hidden" name="k" value="${escapeHtml(row.k)}" />
          <button class="contrast" type="submit">Delete</button>
        </form>
      </td>
    </tr>
  `).join('');

  const placeholderList = responseVars.length
    ? responseVars.map((name) => {
        const hasValue = Boolean(varsByKey[name]);
        return `
          <li style="padding: 0.5rem 0; display: flex; justify-content: space-between; gap: 1rem; align-items: center; border-bottom: 1px solid var(--muted-border-color);">
            <div>
              <code>{{vars.${escapeHtml(name)}}}</code>
              <p class="muted" style="margin: 0.25rem 0 0;">${hasValue ? 'Saved and ready to use' : 'Needs a value. Add one below.'}</p>
            </div>
            <span class="tag ${hasValue ? 'success' : ''}" style="min-width: 8rem; text-align: center;">
              ${hasValue ? 'Value added' : 'Pending'}
            </span>
          </li>
        `;
      }).join('')
    : `<li class="muted" style="padding: 0.5rem 0;">No placeholders detected yet. You can still add custom variables below.</li>`;

  const placeholderOptions = responseVars.length
    ? [`<option value="">Pick a placeholder from the response…</option>`, ...responseVars.map((name) => `<option value="${escapeHtml(name)}">{{vars.${escapeHtml(name)}}}</option>`), '<option value="__custom__">Something else…</option>'].join('')
    : `<option value="__custom__" selected>Type a variable name</option>`;

  const adminKeyHiddenInput = query.key ? `<input type="hidden" name="key" value="${escapeHtml(query.key)}" />` : '';
  const buildQueryString = (params = {}) => {
    const pieces = [];
    if (query.key) {
      pieces.push(`key=${encodeURIComponent(query.key)}`);
    }
    for (const [name, value] of Object.entries(params)) {
      if (value === undefined || value === null || value === '') continue;
      pieces.push(`${encodeURIComponent(name)}=${encodeURIComponent(value)}`);
    }
    return pieces.length ? `?${pieces.join('&')}` : '';
  };

  const paramSections = (pathParams || []).map((paramName) => {
    const groups = Object.entries((paramGroups && paramGroups[paramName]) || {}).sort((a, b) => String(a[0]).localeCompare(String(b[0]), undefined, { numeric: true, sensitivity: 'base' }));
    const isActive = activeParam === paramName && activeValue;
    const hasActiveGroup = Boolean(paramGroups && paramGroups[paramName] && paramGroups[paramName][activeValue]);

    const newGroupNotice = isActive && !hasActiveGroup && activeValue
      ? `
          <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--muted-border-color);">
            <div>
              <code>${escapeHtml(`${paramName}.${activeValue}`)}</code>
              <p class="muted" style="margin: 0.25rem 0 0;">New value selected. Add fields using the editor below.</p>
            </div>
          </li>
        `
      : '';

    const groupItems = groups.length
      ? groups.map(([value, fields]) => {
          const fieldKeys = Object.keys(fields || {});
          const summary = fieldKeys.length === 1 ? '1 field' : `${fieldKeys.length} fields`;
          const previewFields = fieldKeys.slice(0, 3).map((field) => `<code>${escapeHtml(field)}</code>`).join(', ');
          const preview = previewFields
            ? `${summary} · ${previewFields}${fieldKeys.length > 3 ? ', …' : ''}`
            : summary;
          const linkQuery = buildQueryString({ groupParam: paramName, groupValue: value });
          return `
            <li style="padding: 0.75rem 0; display: flex; justify-content: space-between; gap: 1rem; align-items: center; border-bottom: 1px solid var(--muted-border-color);">
              <div>
                <code>${escapeHtml(`${paramName}.${value}`)}</code>
                <p class="muted" style="margin: 0.25rem 0 0;">${preview}</p>
              </div>
              <a class="secondary" href="/admin/${encodeURIComponent(e.id)}/vars${linkQuery}">Edit values</a>
            </li>
          `;
        }).join('')
      : '';

    const groupListFallback = !groupItems && !newGroupNotice
      ? `<li class="muted" style="padding: 0.75rem 0;">No saved values yet. Start by entering a value below.</li>`
      : '';

    const activeFields = isActive ? ((paramGroups && paramGroups[paramName] && paramGroups[paramName][activeValue]) || {}) : {};
    const sortedFieldEntries = Object.entries(activeFields).sort((a, b) => String(a[0]).localeCompare(String(b[0]), undefined, { numeric: true, sensitivity: 'base' }));
    const fieldRows = sortedFieldEntries.map(([fieldName, fieldValue]) => `
      <tr>
        <td style="width: 30%; vertical-align: top;"><code>${escapeHtml(fieldName)}</code></td>
        <td>
          <div class="stack" style="gap: 0.5rem;">
            <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/save${keyQuery}" class="stack" style="gap: 0.5rem;">
              ${adminKeyHiddenInput}
              <input type="hidden" name="groupParam" value="${escapeHtml(paramName)}" />
              <input type="hidden" name="groupValue" value="${escapeHtml(activeValue)}" />
              <input type="hidden" name="k" value="${escapeHtml(`${paramName}.${activeValue}.${fieldName}`)}" />
              <textarea name="v" rows="2" placeholder="Update the value">${escapeHtml(fieldValue)}</textarea>
              <div class="flex" style="gap: 0.5rem; justify-content: flex-end;">
                <button type="submit" class="secondary">Save changes</button>
              </div>
            </form>
            <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/delete${keyQuery}" onsubmit="return confirm('Delete this field?');" style="align-self: flex-end;">
              ${adminKeyHiddenInput}
              <input type="hidden" name="groupParam" value="${escapeHtml(paramName)}" />
              <input type="hidden" name="groupValue" value="${escapeHtml(activeValue)}" />
              <input type="hidden" name="k" value="${escapeHtml(`${paramName}.${activeValue}.${fieldName}`)}" />
              <button type="submit" class="contrast">Delete field</button>
            </form>
          </div>
        </td>
      </tr>
    `).join('');

    const fieldTable = isActive
      ? (fieldRows
          ? `
            <table>
              <thead>
                <tr><th style="width: 30%;">Field</th><th>Value</th></tr>
              </thead>
              <tbody>
                ${fieldRows}
              </tbody>
            </table>
          `
          : `<p class="muted" style="margin: 0;">No values added yet. Use the form below to capture data for this value.</p>`)
      : '';

    const addFieldForm = isActive
      ? `
          <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/save${keyQuery}" class="stack" style="gap: 0.75rem; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 1rem; background: var(--surface-color, #fff);">
            ${adminKeyHiddenInput}
            <input type="hidden" name="groupParam" value="${escapeHtml(paramName)}" />
            <input type="hidden" name="groupValue" value="${escapeHtml(activeValue)}" />
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
              <label>
                Field name
                <input name="fieldName" placeholder="name" required />
                <small class="muted">Appears in templates as <code>{{${escapeHtml(paramName)}.FIELD}}</code> when the request value matches <code>${escapeHtml(activeValue)}</code>.</small>
              </label>
              <label>
                Value
                <textarea name="fieldValue" rows="2" placeholder="Example: Jane Doe"></textarea>
                <small class="muted">Provide the mock data returned for this field.</small>
              </label>
            </div>
            <button type="submit" class="button primary" style="align-self: flex-start;">Add field</button>
          </form>
        `
      : '';

    const closeEditorLink = isActive
      ? `<a class="secondary" href="/admin/${encodeURIComponent(e.id)}/vars${buildQueryString({})}">Close editor</a>`
      : '';

    const editorSection = isActive
      ? `
          <div class="stack" style="gap: 1rem; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 1.25rem; background: var(--surface-color, #fff);">
            <div class="flex" style="justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
              <div class="stack" style="gap: 0.25rem;">
                <h4 style="margin: 0;">Editing <code>${escapeHtml(paramName)}.${escapeHtml(activeValue)}</code></h4>
                <p class="muted" style="margin: 0;">When a request includes <code>${escapeHtml(paramName)}=${escapeHtml(activeValue)}</code>, templates can reference <code>{{${escapeHtml(paramName)}.FIELD}}</code>.</p>
              </div>
              ${closeEditorLink}
            </div>
            ${fieldTable}
            ${addFieldForm}
          </div>
        `
      : '';

    return `
      <section class="stack" style="gap: 1rem;">
        <header class="stack" style="gap: 0.25rem;">
          <h4 style="margin: 0;">Parameter <code>:${escapeHtml(paramName)}</code></h4>
          <p class="muted" style="margin: 0;">Group values for the <code>${escapeHtml(paramName)}</code> path parameter and attach fields you can reuse in templates.</p>
        </header>
        <form method="get" action="/admin/${encodeURIComponent(e.id)}/vars" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; align-items: end;">
          ${query.key ? `<input type="hidden" name="key" value="${escapeHtml(query.key)}" />` : ''}
          <input type="hidden" name="groupParam" value="${escapeHtml(paramName)}" />
          <label>
            ${`Add a new ${escapeHtml(paramName)} value`}
            <input name="groupValue" placeholder="001" required />
          </label>
          <button type="submit" class="button secondary" style="height: 100%;">Start editing</button>
        </form>
        <ul style="list-style: none; padding: 0; margin: 0; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 0 1rem; background: var(--muted-border-color, #f4f6f8);">
          ${newGroupNotice}
          ${groupItems}
          ${groupListFallback}
        </ul>
        ${editorSection}
      </section>
    `;
  }).join('');

  const paramIntroList = (pathParams || []).map((p) => `<code>:${escapeHtml(p)}</code>`).join(', ');
  const paramTemplateExamples = (pathParams || []).map((p) => `<code>{{${escapeHtml(p)}.FIELD}}</code>`).join(' or ') || '<code>{{param.FIELD}}</code>';

  const paramManagementSection = (pathParams && pathParams.length)
    ? `
      <section class="stack" style="gap: 1rem;">
        <h3 style="margin: 0;">Step 3 · Add data for path parameters</h3>
        <p class="muted" style="margin: 0;">Your endpoint path includes parameters (${paramIntroList}). Create records for each value (for example <code>001</code>) and attach fields like name, email, or phone. Templates can then use expressions such as ${paramTemplateExamples} when the request matches.</p>
        <div class="stack" style="gap: 1.5rem;">
          ${paramSections}
        </div>
      </section>
    `
    : '';

  const reviewStepNumber = (pathParams && pathParams.length) ? 4 : 3;

  const body = `
    <section class="stack" style="display: flex; flex-direction: column; gap: 2rem;">
      <header class="flex" style="justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
        <div class="stack" style="gap: 0.5rem;">
          <h2 style="margin: 0;">Variables for <code>${escapeHtml(e.method)} ${escapeHtml(e.path)}</code></h2>
          <p class="muted" style="margin: 0; max-width: 60ch;">Follow the guided steps to capture the values you want to reuse. We’ve scanned the response body and surfaced any placeholders we found.</p>
        </div>
        <a class="secondary" href="/admin/${encodeURIComponent(e.id)}${keyQuery}">Back to endpoint</a>
      </header>

      <section class="stack" style="gap: 1rem;">
        <h3 style="margin: 0;">Step 1 · Review the placeholders</h3>
        <p class="muted" style="margin: 0;">These come straight from the response body (<code>{{vars.NAME}}</code> format).</p>
        <ul style="list-style: none; padding: 0; margin: 0; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 0.5rem 1rem; background: var(--muted-border-color, #f4f6f8);">
          ${placeholderList}
        </ul>
      </section>

      <section class="stack" style="gap: 1rem;">
        <h3 style="margin: 0;">Step 2 · Capture a value</h3>
        <p class="muted" style="margin: 0;">Work through the placeholders one at a time. Pick a name, add the friendly value, and save it.</p>
        <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/save${keyQuery}" class="stack" style="gap: 1rem; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 1.25rem; background: var(--surface-color, #fff);">
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
            <label>
              Choose a variable name
              <select data-var-picker ${responseVars.length ? '' : 'hidden'}>
                ${placeholderOptions}
              </select>
              ${responseVars.length ? '<small class="muted">We filled this from your response body. Pick one to pre-fill the name.</small>' : '<small class="muted">No placeholders yet? Type a custom name below.</small>'}
            </label>
            <label data-custom-wrapper ${responseVars.length ? '' : 'style="display:block;"'}>
              Variable key
              <input name="k" placeholder="userId" required data-var-key />
              <small class="muted">Use plain letters, numbers, or underscores. This becomes <code>{{vars.YOUR_KEY}}</code>.</small>
            </label>
            <label>
              Friendly value
              <textarea name="v" rows="2" placeholder="Example: John Doe" required></textarea>
              <small class="muted">This is the content that will replace the placeholder in responses.</small>
            </label>
          </div>
          <button type="submit" class="button primary" style="align-self: flex-start;">Save variable</button>
        </form>
      </section>

      ${paramManagementSection}

      <section class="stack" style="gap: 1rem;">
        <h3 style="margin: 0;">Step ${reviewStepNumber} · Review saved variables</h3>
        <p class="muted" style="margin: 0;">Update or remove any values below. Each key maps directly to a placeholder in your responses.</p>
        <table>
          <thead>
            <tr><th>Key</th><th>Value</th><th></th></tr>
          </thead>
          <tbody>
            ${varsRows || `<tr><td colspan="3" class="muted">No variables yet. Add one above to get started.</td></tr>`}
          </tbody>
        </table>
      </section>
    </section>
  `;
%>
<%- include('layout', {
  title: `Variables · ${e.method} ${e.path}`,
  body,
  scripts: `
    <script>
      (function() {
        const picker = document.querySelector('[data-var-picker]');
        const keyInput = document.querySelector('[data-var-key]');
        const customWrapper = document.querySelector('[data-custom-wrapper]');
        if (!keyInput) return;

        function syncFromPicker(value) {
          if (!value || value === '__custom__') {
            if (customWrapper) {
              customWrapper.style.display = 'block';
            }
            keyInput.removeAttribute('readonly');
            if (value !== '__custom__') {
              keyInput.value = '';
            }
            keyInput.focus();
            return;
          }

          keyInput.value = value;
          keyInput.setAttribute('readonly', 'readonly');
          if (customWrapper) {
            customWrapper.style.display = 'block';
          }
        }

        if (picker) {
          syncFromPicker(picker.value);
          picker.addEventListener('change', (event) => {
            syncFromPicker(event.target.value);
          });
        } else {
          syncFromPicker('__custom__');
        }
      })();
    </script>
  `
}) %>
