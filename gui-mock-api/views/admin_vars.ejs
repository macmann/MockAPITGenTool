<%
  const escapeHtml = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const keyQuery = query.key ? `?key=${encodeURIComponent(query.key)}` : '';
  const responseBody = String(e.response_body || '');
  const pathParamsList = Array.isArray(pathParams) ? pathParams : [];
  const placeholderRegex = /{{\s*([A-Za-z0-9_]+(?:\.[A-Za-z0-9_\.\-]+)?)\s*}}/g;
  const responseVars = [];
  const paramPlaceholderMap = {};
  let match;
  while ((match = placeholderRegex.exec(responseBody)) !== null) {
    const token = match[1];
    if (!token) continue;

    if (token.startsWith('vars.')) {
      const name = token.slice(5);
      if (name && !responseVars.includes(name)) {
        responseVars.push(name);
      }
      continue;
    }

    const [root, ...restParts] = token.split('.');
    if (!root || restParts.length === 0) {
      continue;
    }

    if (!pathParamsList.includes(root)) {
      continue;
    }

    const fieldName = restParts.join('.');
    if (!fieldName) continue;

    if (!paramPlaceholderMap[root]) {
      paramPlaceholderMap[root] = [];
    }

    if (!paramPlaceholderMap[root].includes(fieldName)) {
      paramPlaceholderMap[root].push(fieldName);
    }
  }

  const paramFieldHasValues = {};
  for (const [paramName, valueMap] of Object.entries(paramGroups || {})) {
    for (const fields of Object.values(valueMap || {})) {
      for (const fieldName of Object.keys(fields || {})) {
        if (!paramFieldHasValues[paramName]) {
          paramFieldHasValues[paramName] = {};
        }
        paramFieldHasValues[paramName][fieldName] = true;
      }
    }
  }

  const varsByKey = Object.fromEntries((vars || []).map((row) => [row.k, row]));

  const varsTableRows = (vars || []).filter((row) => !String(row.k || '').startsWith('__group__.'));
  const varsRows = varsTableRows.map((row) => `
    <tr>
      <td><code>${escapeHtml(row.k)}</code></td>
      <td>${escapeHtml(row.v)}</td>
      <td>
        <div class="table-actions">
          <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/delete${keyQuery}" onsubmit="return confirm('Delete variable?');">
            <input type="hidden" name="k" value="${escapeHtml(row.k)}" />
            <button class="button contrast" type="submit">Delete</button>
          </form>
        </div>
      </td>
    </tr>
  `).join('');

  const placeholderEntries = [];

  for (const name of responseVars) {
    const hasValue = Boolean(varsByKey[name]);
    placeholderEntries.push(`
      <li style="padding: 0.5rem 0; display: flex; justify-content: space-between; gap: 1rem; align-items: center; border-bottom: 1px solid var(--muted-border-color);">
        <div>
          <code>{{vars.${escapeHtml(name)}}}</code>
          <p class="muted" style="margin: 0.25rem 0 0;">${hasValue ? 'Saved and ready to use' : 'Needs a value. Add one below.'}</p>
        </div>
        <span class="tag ${hasValue ? 'success' : ''}" style="min-width: 8rem; text-align: center;">
          ${hasValue ? 'Value added' : 'Pending'}
        </span>
      </li>
    `);
  }

  for (const [paramName, fields] of Object.entries(paramPlaceholderMap)) {
    const sortedFields = [...fields].sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true, sensitivity: 'base' }));
    for (const fieldName of sortedFields) {
      const hasValue = Boolean(paramFieldHasValues[paramName]?.[fieldName]);
      const statusMessage = hasValue
        ? `Saved for at least one ${escapeHtml(paramName)} value`
        : 'Add this field in Step 3 below to reuse it in templates.';
      placeholderEntries.push(`
        <li style="padding: 0.5rem 0; display: flex; justify-content: space-between; gap: 1rem; align-items: center; border-bottom: 1px solid var(--muted-border-color);">
          <div>
            <code>{{${escapeHtml(`${paramName}.${fieldName}`)}}}</code>
            <p class="muted" style="margin: 0.25rem 0 0;">${statusMessage}</p>
          </div>
          <span class="tag ${hasValue ? 'success' : ''}" style="min-width: 8rem; text-align: center;">
            ${hasValue ? 'Value added' : 'Pending'}
          </span>
        </li>
      `);
    }
  }

  const placeholderList = placeholderEntries.length
    ? placeholderEntries.join('')
    : `<li class="muted" style="padding: 0.5rem 0;">No placeholders detected yet. Add tokens like <code>{{vars.NAME}}</code> or <code>{{userid.name}}</code> to your response body to unlock guided setup.</li>`;

  const adminKeyHiddenInput = query.key ? `<input type="hidden" name="key" value="${escapeHtml(query.key)}" />` : '';
  const buildQueryString = (params = {}) => {
    const pieces = [];
    if (query.key) {
      pieces.push(`key=${encodeURIComponent(query.key)}`);
    }
    for (const [name, value] of Object.entries(params)) {
      if (value === undefined || value === null || value === '') continue;
      pieces.push(`${encodeURIComponent(name)}=${encodeURIComponent(value)}`);
    }
    return pieces.length ? `?${pieces.join('&')}` : '';
  };

  const pathParamOptions = pathParamsList.map((paramName) => `<option value="${escapeHtml(paramName)}">:${escapeHtml(paramName)}</option>`).join('');
  const defaultPathParam = pathParamsList[0] || '';

  const paramSections = (pathParams || []).map((paramName) => {
    const groups = Object.entries((paramGroups && paramGroups[paramName]) || {}).sort((a, b) => String(a[0]).localeCompare(String(b[0]), undefined, { numeric: true, sensitivity: 'base' }));
    const isActive = activeParam === paramName && activeValue;
    const hasActiveGroup = Boolean(paramGroups && paramGroups[paramName] && paramGroups[paramName][activeValue]);

    const newGroupNotice = isActive && !hasActiveGroup && activeValue
      ? `
          <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--muted-border-color);">
            <div>
              <code>${escapeHtml(`${paramName}.${activeValue}`)}</code>
              <p class="muted" style="margin: 0.25rem 0 0;">New value selected. Add fields using the editor below.</p>
            </div>
          </li>
        `
      : '';

    const groupItems = groups.length
      ? groups.map(([value, fields]) => {
          const fieldKeys = Object.keys(fields || {});
          const summary = fieldKeys.length === 0
            ? 'No values yet'
            : fieldKeys.length === 1
              ? '1 value'
              : `${fieldKeys.length} values`;
          const previewFields = fieldKeys.slice(0, 3).map((field) => `<code>${escapeHtml(field)}</code>`).join(', ');
          const preview = previewFields
            ? `${summary} · ${previewFields}${fieldKeys.length > 3 ? ', …' : ''}`
            : summary;
          const linkQuery = buildQueryString({ groupParam: paramName, groupValue: value });
          return `
            <li style="padding: 0.75rem 0; display: flex; justify-content: space-between; gap: 1rem; align-items: center; border-bottom: 1px solid var(--muted-border-color);">
              <div>
                <code>${escapeHtml(`${paramName}.${value}`)}</code>
                <p class="muted" style="margin: 0.25rem 0 0;">${preview}</p>
              </div>
              <a class="secondary" href="/admin/${encodeURIComponent(e.id)}/vars${linkQuery}">Edit values</a>
            </li>
          `;
        }).join('')
      : '';

    const groupListFallback = !groupItems && !newGroupNotice
      ? `<li class="muted" style="padding: 0.75rem 0;">No saved values yet. Start by entering a value below.</li>`
      : '';

    const activeFields = isActive ? ((paramGroups && paramGroups[paramName] && paramGroups[paramName][activeValue]) || {}) : {};
    const sortedFieldEntries = Object.entries(activeFields).sort((a, b) => String(a[0]).localeCompare(String(b[0]), undefined, { numeric: true, sensitivity: 'base' }));
    const placeholderFields = Array.isArray(paramPlaceholderMap[paramName]) ? [...new Set(paramPlaceholderMap[paramName])] : [];
    const sortedPlaceholderFields = [...placeholderFields].sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true, sensitivity: 'base' }));
    const additionalFieldEntries = sortedFieldEntries.filter(([fieldName]) => !sortedPlaceholderFields.includes(fieldName));

    const renderFieldEditor = (fieldName, value, options = {}) => {
      const disabled = options.disabled ? 'disabled' : '';
      const helper = options.helper || '';
      return `
        <div class="stack" style="gap: 0.25rem;">
          <label class="stack" style="gap: 0.25rem;">
            <span style="font-weight: 600; display: flex; justify-content: space-between; align-items: baseline;">
              <span><code>${escapeHtml(fieldName)}</code></span>
              ${helper}
            </span>
            <input type="hidden" name="fieldName" value="${escapeHtml(fieldName)}" />
            <textarea name="fieldValue" rows="2" ${disabled} placeholder="Enter a value">${escapeHtml(value ?? '')}</textarea>
          </label>
        </div>
      `;
    };

    const placeholderEditors = sortedPlaceholderFields.map((fieldName) => {
      const existingValue = activeFields[fieldName] || '';
      return renderFieldEditor(fieldName, existingValue, {
        helper: `<small class="muted">Appears as <code>{{${escapeHtml(paramName)}.${escapeHtml(fieldName)}}</code></small>`
      });
    }).join('');

    const additionalEditors = additionalFieldEntries.map(([fieldName, fieldValue]) => renderFieldEditor(fieldName, fieldValue)).join('');

    const editorFormBody = placeholderEditors || additionalEditors
      ? `${placeholderEditors}${additionalEditors}`
      : `<p class="muted" style="margin: 0;">Add placeholders like <code>{{${escapeHtml(paramName)}.name}}</code> to your response to unlock guided fields.</p>`;

    const editorForm = isActive
      ? `
          <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/save${keyQuery}" class="stack" style="gap: 1rem;">
            ${adminKeyHiddenInput}
            <input type="hidden" name="groupParam" value="${escapeHtml(paramName)}" />
            <input type="hidden" name="groupValue" value="${escapeHtml(activeValue)}" />
            ${editorFormBody}
            ${(placeholderEditors || additionalEditors) ? '<button type="submit" class="button primary" style="align-self: flex-start;">Save values</button>' : ''}
          </form>
        `
      : '';

    const closeEditorLink = isActive
      ? `<a class="secondary" href="/admin/${encodeURIComponent(e.id)}/vars${buildQueryString({})}">Close editor</a>`
      : '';

    const editorSection = isActive
      ? `
          <div class="stack" style="gap: 1rem; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 1.25rem; background: var(--surface-color, #fff);">
            <div class="flex" style="justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
              <div class="stack" style="gap: 0.25rem;">
                <h4 style="margin: 0;">Editing <code>${escapeHtml(paramName)}.${escapeHtml(activeValue)}</code></h4>
                <p class="muted" style="margin: 0;">When a request includes <code>${escapeHtml(paramName)}=${escapeHtml(activeValue)}</code>, templates can reference <code>{{${escapeHtml(paramName)}.FIELD}}</code>.</p>
              </div>
              ${closeEditorLink}
            </div>
            ${editorForm}
          </div>
        `
      : '';

    return `
      <section class="stack" style="gap: 1rem;">
        <header class="stack" style="gap: 0.25rem;">
          <h4 style="margin: 0;">Parameter <code>:${escapeHtml(paramName)}</code></h4>
          <p class="muted" style="margin: 0;">Group values for the <code>${escapeHtml(paramName)}</code> path parameter and attach fields you can reuse in templates.</p>
        </header>
        <form method="get" action="/admin/${encodeURIComponent(e.id)}/vars" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; align-items: end;">
          ${query.key ? `<input type="hidden" name="key" value="${escapeHtml(query.key)}" />` : ''}
          <input type="hidden" name="groupParam" value="${escapeHtml(paramName)}" />
          <label>
            ${`Add a new ${escapeHtml(paramName)} value`}
            <input name="groupValue" placeholder="001" required />
          </label>
          <button type="submit" class="button secondary" style="height: 100%;">Start editing</button>
        </form>
        <ul style="list-style: none; padding: 0; margin: 0; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 0 1rem; background: var(--muted-border-color, #f4f6f8);">
          ${newGroupNotice}
          ${groupItems}
          ${groupListFallback}
        </ul>
        ${editorSection}
      </section>
    `;
  }).join('');

  const paramIntroList = (pathParams || []).map((p) => `<code>:${escapeHtml(p)}</code>`).join(', ');
  const paramTemplateExamples = (pathParams || []).map((p) => `<code>{{${escapeHtml(p)}.FIELD}}</code>`).join(' or ') || '<code>{{param.FIELD}}</code>';

  const paramManagementSection = (pathParams && pathParams.length)
    ? `
      <section class="stack" style="gap: 1rem;">
        <h3 style="margin: 0;">Step 3 · Fill in values for each ID</h3>
        <p class="muted" style="margin: 0;">We found path parameters (${paramIntroList}). After adding IDs in Step 2, select one below to attach the fields you want to reuse in templates (for example ${paramTemplateExamples}).</p>
        <div class="stack" style="gap: 1.5rem;">
          ${paramSections}
        </div>
      </section>
    `
    : '';

  const reviewStepNumber = (pathParams && pathParams.length) ? 4 : 3;

  const body = `
    <section class="page-hero page-hero--compact">
      <div class="page-hero__content">
        <h2>Variables for <code>${escapeHtml(e.method)} ${escapeHtml(e.path)}</code></h2>
        <p>Follow the guided steps to capture the values you want to reuse. We’ve scanned the response body and surfaced any placeholders we found.</p>
      </div>
      <div class="page-hero__actions">
        <a class="secondary" href="/admin/${encodeURIComponent(e.id)}${keyQuery}">Back to endpoint</a>
      </div>
    </section>
    <section class="surface-card surface-card--stacked stack stack--xl">
      <section class="stack" style="gap: 1rem;">
        <h3 style="margin: 0;">Step 1 · Review the placeholders</h3>
        <p class="muted" style="margin: 0;">These come straight from the response body (for example <code>{{vars.NAME}}</code> or <code>{{userid.name}}</code>).</p>
        <ul style="list-style: none; padding: 0; margin: 0; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 0.5rem 1rem; background: var(--muted-border-color, #f4f6f8);">
          ${placeholderList}
        </ul>
      </section>

      <section class="stack" style="gap: 1rem;">
        <h3 style="margin: 0;">Step 2 · Add IDs to manage</h3>
        <p class="muted" style="margin: 0;">Enter the path values you want to support (for example a <code>:userid</code> like <code>001</code>). We’ll list them below so you can fill in their fields.</p>
        ${(pathParamsList.length)
          ? `
            <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/save${keyQuery}" class="stack" style="gap: 1rem; border: 1px solid var(--muted-border-color); border-radius: 0.5rem; padding: 1.25rem; background: var(--surface-color, #fff);">
              ${adminKeyHiddenInput}
              <input type="hidden" name="createGroup" value="1" />
              <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; align-items: end;">
                ${(pathParamsList.length > 1)
                  ? `
                      <label>
                        Choose a path parameter
                        <select name="groupParam" required>
                          ${pathParamOptions}
                        </select>
                        <small class="muted">Pick which parameter this ID belongs to.</small>
                      </label>
                    `
                  : `
                      <div class="stack" style="gap: 0.25rem;">
                        <input type="hidden" name="groupParam" value="${escapeHtml(defaultPathParam)}" />
                        <span class="muted">Parameter: <code>:${escapeHtml(defaultPathParam)}</code></span>
                      </div>
                    `}
                <label>
                  ID or value
                  <input name="groupValue" placeholder="001" required />
                  <small class="muted">We’ll show this in Step 3 so you can attach the detailed fields.</small>
                </label>
              </div>
              <button type="submit" class="button primary" style="align-self: flex-start;">Save ID</button>
            </form>
          `
          : `<p class="muted" style="margin: 0;">This endpoint doesn’t include path parameters yet. Add something like <code>/:userid</code> to the path to unlock ID management.</p>`}
      </section>

      ${paramManagementSection}

      <section class="stack" style="gap: 1rem;">
        <h3 style="margin: 0;">Step ${reviewStepNumber} · Review saved variables</h3>
        <p class="muted" style="margin: 0;">Update or remove any values below. Each key maps directly to a placeholder in your responses.</p>
        <div class="table-card">
          <table>
            <thead>
              <tr><th>Key</th><th>Value</th><th>Actions</th></tr>
            </thead>
            <tbody>
              ${varsRows || `<tr><td class="empty-state" colspan="3">No variables yet. Add one above to get started.</td></tr>`}
            </tbody>
          </table>
        </div>
      </section>
    </section>
  `;
%>
<%- include('layout', {
  title: `Variables · ${e.method} ${e.path}`,
  body,
  scripts: ''
}) %>
